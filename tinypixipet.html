<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tiny Pixi Pet — LocalStorage + Vue</title>
  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#666; --card:#f5f5f5; --accent:#0a7;
    }
    html,body{height:100%;}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg);}
    header{padding:12px 16px; border-bottom:1px solid #e5e5e5; display:flex; align-items:center; gap:12px;}
    header h1{font-size:18px; margin:0; font-weight:700;}
    header .sub{color:var(--muted); font-size:13px;}
    main{display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px;}
    @media (max-width: 900px){ main{grid-template-columns:1fr;}}
    .panel{background:var(--card); border:1px solid #e9e9e9; border-radius:14px; padding:14px;}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:8px 0;}
    .label{font-size:13px; color:var(--muted)}
    .value{font-weight:700; min-width:32px; text-align:right}
    .bar{position:relative; height:10px; background:#ddd; border-radius:999px; overflow:hidden;}
    .bar > i{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #8be, #0a7);}
    .controls{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .controls button{appearance:none; border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600}
    .controls button:hover{border-color:#bbb}
    .hint{font-size:12px; color:var(--muted);}
    .stack{display:grid; gap:12px}
    .section-title{font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:#888;}
    .danger{color:#a00}
    #pixiMount{width:100%; height:480px; background:#eef6f3; border:1px solid #d5e9e2; border-radius:16px}
    textarea{width:100%; min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; border-radius:10px; border:1px solid #ddd; padding:8px}
    details{background:#fafafa; border:1px dashed #ddd; padding:10px; border-radius:10px}
    kbd{background:#eee; border:1px solid #ddd; border-bottom-color:#bbb; padding:0 6px; border-radius:6px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e0e0e0; background:#fff}
  </style>
</head>
<body>
  <header>
    <h1>🟢 Tiny Pixi Pet</h1>
    <span class="sub">LocalStorage • JSON save • PIXI.js canvas • Vue (CDN)</span>
    <span class="pill" id="versionPill"></span>
  </header>

  <main id="app">
    <!-- Left: Stats & Controls -->
    <section class="panel stack">
      <div>
        <div class="section-title">Pet</div>
        <div class="row"><div class="label">Name</div>
          <input v-model="state.name" @change="persist()" style="width:160px; padding:6px 8px; border-radius:8px; border:1px solid #ddd;" placeholder="Name your pet" />
        </div>
        <div class="row"><div class="label">Age</div><div class="value">{{ prettyAge }}</div></div>
        <div class="row"><div class="label">Mood</div><div class="value">{{ moodLabel }}</div></div>
      </div>

      <div>
        <div class="section-title">Vitals</div>
        <div class="row"><div class="label">Hunger</div><div class="value">{{ state.hunger }}</div></div>
        <div class="bar"><i :style="{width: (100 - state.hunger) + '%'}"></i></div>
        <div class="row"><div class="label">Energy</div><div class="value">{{ state.energy }}</div></div>
        <div class="bar"><i :style="{width: state.energy + '%'}"></i></div>
        <div class="row"><div class="label">Cleanliness</div><div class="value">{{ state.cleanliness }}</div></div>
        <div class="bar"><i :style="{width: state.cleanliness + '%'}"></i></div>
        <div class="row"><div class="label">Happiness</div><div class="value">{{ state.happiness }}</div></div>
        <div class="bar"><i :style="{width: state.happiness + '%'}"></i></div>
      </div>

      <div>
        <div class="section-title">Actions</div>
        <div class="controls">
          <button @click="doFeed">🍎 Feed</button>
          <button @click="doPlay">🎾 Play</button>
          <button @click="doSleep">💤 Sleep</button>
          <button @click="doClean">🧼 Clean</button>
          <button @click="nudge">✨ Nudge</button>
        </div>
        <div class="hint">Each action tweaks stats and triggers a small animation. Time passes every second.</div>
      </div>

      <div>
        <div class="section-title">Saves</div>
        <div class="controls">
          <button @click="persist">💾 Save</button>
          <button @click="exportJSON">⬇️ Export JSON</button>
          <button @click="importJSON">⬆️ Import JSON</button>
          <button class="danger" @click="resetAll">♻️ Reset</button>
        </div>
        <details>
          <summary>Show save JSON</summary>
          <textarea v-model="jsonBuffer"></textarea>
          <div class="hint">Tip: Copy this somewhere safe. Paste and click <b>Import JSON</b> to restore.</div>
        </details>
      </div>

      <div>
        <div class="section-title">Notes</div>
        <ul style="margin:6px 0 0 18px; padding:0; color:#555; font-size:13px; line-height:1.4">
          <li>State is stored under <code>localStorage["tinyPet.v1"]</code>.</li>
          <li>Hunger rises over time; energy and cleanliness drift down; happiness follows the rest.</li>
          <li>Mood tints the pet: green (happy) → yellow (ok) → red (sad).</li>
        </ul>
      </div>
    </section>

    <!-- Right: PIXI Stage -->
    <section class="panel">
      <div class="section-title">Playground</div>
      <div id="pixiMount" ref="pixiMount"></div>
    </section>
  </main>

  <!-- Libraries (UMD/CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.5.12/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.5.1/dist/pixi.min.js"></script>

  <script>
  ;(() => {
    const VERSION = 'v1.0.0';
    document.getElementById('versionPill').textContent = VERSION;

    const STORAGE_KEY = 'tinyPet.v1';
    const clamp = (n, lo=0, hi=100) => Math.max(lo, Math.min(hi, Math.round(n)));

    const defaultState = () => ({
      name: 'Pixel',
      hunger: 20,        // 0 (full) .. 100 (starving)
      energy: 80,        // 0 .. 100
      cleanliness: 90,   // 0 .. 100
      happiness: 80,     // 0 .. 100
      ageSeconds: 0,
      lastTick: Date.now(),
      version: VERSION
    });

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        return Object.assign(defaultState(), parsed);
      }catch(e){
        console.warn('Failed to load state, using defaults', e);
        return defaultState();
      }
    }

    function save(state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // Vue App
    const { createApp, onMounted, ref, reactive, computed } = Vue;
    createApp({
      setup(){
        const state = reactive(load());
        const jsonBuffer = ref(JSON.stringify(state, null, 2));
        const pixiMount = ref(null);
        let app = null, pet = null, eyes = [], mouth = null, poopGroup = null;
        let idlePhase = 0;

        const prettyAge = computed(() => {
          const s = state.ageSeconds|0;
          const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const ss = s%60;
          return `${h}h ${m}m ${ss}s`;
        });

        const moodScore = computed(() => (state.happiness + (100 - state.hunger) + state.energy + state.cleanliness)/4);
        const moodLabel = computed(() => {
          const ms = moodScore.value;
          if(ms >= 75) return '😊 Happy';
          if(ms >= 45) return '🙂 Okay';
          return '😟 Needs care';
        });

        function tintFromMood(){
          const ms = moodScore.value; // 0..100
          // Map 0..100 to red→yellow→green (roughly)
          // We'll lerp between #d33 (sad), #e6c229 (ok), #2ecc71 (happy)
          const sad = 0xDD3333, ok = 0xE6C229, happy = 0x2ECC71;
          let c;
          if(ms < 50){
            const t = ms/50; c = lerpColor(sad, ok, t);
          } else {
            const t = (ms-50)/50; c = lerpColor(ok, happy, t);
          }
          return c;
        }
        function lerpColor(a,b,t){
          const ar=(a>>16)&255, ag=(a>>8)&255, ab=a&255;
          const br=(b>>16)&255, bg=(b>>8)&255, bb=b&255;
          const r = ar + (br-ar)*t;
          const g = ag + (bg-ag)*t;
          const bl= ab + (bb-ab)*t;
          return ((r&255)<<16)|((g&255)<<8)|((bl&255));
        }

        function buildPet(stage){
          const g = new PIXI.Graphics();
          g.circle(0,0,70).fill(0x2ECC71); // body
          stage.addChild(g);

          const leftEye = new PIXI.Graphics().circle(-25,-10,10).fill(0x000000);
          const rightEye= new PIXI.Graphics().circle( 25,-10,10).fill(0x000000);
          const mouthG  = new PIXI.Graphics();
          mouthG.roundRect(-22,20,44,10,5).fill(0x000000);
          stage.addChild(leftEye, rightEye, mouthG);

          const poops = new PIXI.Container();
          stage.addChild(poops);

          eyes = [leftEye, rightEye];
          pet = g; mouth = mouthG; poopGroup = poops;
        }

        function addPoop(){
          if(poopGroup.children.length > 8) return; // cap
          const p = new PIXI.Graphics();
          const x = (Math.random()*180)-90; const y = 80 + Math.random()*40;
          p.circle(x, y, 6).fill(0x7b4a12);
          poopGroup.addChild(p);
        }

        function clearPoop(){
          poopGroup.removeChildren();
        }

        function blink(){
          eyes.forEach(e => e.scale.y = 0.2);
          setTimeout(()=> eyes.forEach(e => e.scale.y = 1), 120);
        }

        function wiggle(){
          const amp = 6;
          let t = 0; const dur = 250; const startX = pet.x;
          const id = setInterval(()=>{
            t += 16; const k = Math.min(1, t/dur);
            pet.x = startX + Math.sin(k*6.28*2)*amp*(1-k);
            if(k>=1){ clearInterval(id); pet.x = startX; }
          }, 16);
        }

        function adjustStats(deltaSeconds){
          const d = Math.max(0, Math.min(5, deltaSeconds));
          state.ageSeconds += d;
          state.hunger = clamp(state.hunger + 0.5*d); // get hungrier
          state.energy = clamp(state.energy - 0.4*d);
          state.cleanliness = clamp(state.cleanliness - 0.25*d);
          // Happiness follows others
          const targetHappy = clamp((100 - state.hunger + state.energy + state.cleanliness)/3);
          const diff = targetHappy - state.happiness;
          state.happiness = clamp(state.happiness + Math.sign(diff)*Math.min(Math.abs(diff), 0.5*d));

          // Low cleanliness spawns poop sometimes
          if(state.cleanliness < 35 && Math.random() < 0.15*d) addPoop();
        }

        function paint(){
          if(!pet) return;
          pet.tint = tintFromMood();
          // mouth shape: smile/flat/frown
          mouth.clear();
          const mood = moodScore.value;
          if(mood >= 70){
            mouth.moveTo(-22,25).quadraticCurveTo(0,38,22,25).stroke({color:0x000000, width:5});
          }else if(mood >= 45){
            mouth.roundRect(-22,25,44,3,2).fill(0x000000);
          }else{
            mouth.moveTo(-22,38).quadraticCurveTo(0,25,22,38).stroke({color:0x000000, width:5});
          }
        }

        function persist(){ save(state); jsonBuffer.value = JSON.stringify(state, null, 2); }

        function loop(){
          const now = Date.now();
          const delta = (now - state.lastTick)/1000;
          if(delta >= 1){
            adjustStats(delta);
            state.lastTick = now;
            paint();
            if(Math.random() < 0.04) blink();
            idlePhase += delta;
            if(pet){ pet.y = 10*Math.sin(idlePhase*1.5); }
            persist();
          }
          requestAnimationFrame(loop);
        }

        function doFeed(){
          state.hunger = clamp(state.hunger - 25);
          state.happiness = clamp(state.happiness + 6);
          wiggle(); persist();
        }
        function doPlay(){
          state.happiness = clamp(state.happiness + 15);
          state.energy = clamp(state.energy - 10);
          blink(); wiggle(); persist();
        }
        function doSleep(){
          state.energy = clamp(state.energy + 25);
          state.hunger = clamp(state.hunger + 8); // wake up hungry
          persist();
        }
        function doClean(){
          state.cleanliness = clamp(state.cleanliness + 30);
          clearPoop(); persist();
        }
        function nudge(){ wiggle(); blink(); }

        function exportJSON(){ jsonBuffer.value = JSON.stringify(state, null, 2); navigator.clipboard?.writeText(jsonBuffer.value).catch(()=>{}); }
        function importJSON(){
          try{
            const parsed = JSON.parse(jsonBuffer.value);
            Object.assign(state, defaultState(), parsed);
            persist(); paint();
          }catch(e){ alert('Invalid JSON'); }
        }
        function resetAll(){
          if(!confirm('Reset pet to defaults?')) return;
          Object.assign(state, defaultState());
          clearPoop();
          persist(); paint();
        }

        onMounted(() => {
          // PIXI Setup
          app = new PIXI.Application();
          app.init({ backgroundAlpha: 0, antialias:true, resizeTo: document.getElementById('pixiMount') }).then(() => {
            pixiMount.value.appendChild(app.canvas);
            const stage = new PIXI.Container();
            app.stage.addChild(stage);

            // Center pet container
            const petWrap = new PIXI.Container();
            petWrap.x = app.renderer.width/2; petWrap.y = app.renderer.height/2 - 10;
            stage.addChild(petWrap);
            buildPet(petWrap);
            paint();

            // Resize handler to keep centered
            const onResize = () => {
              petWrap.x = app.renderer.width/2; petWrap.y = app.renderer.height/2 - 10;
            };
            window.addEventListener('resize', onResize);
          });

          // Start loop
          if(!state.lastTick) state.lastTick = Date.now();
          requestAnimationFrame(loop);
        });

        return {
          state, jsonBuffer, pixiMount,
          prettyAge, moodLabel,
          persist, doFeed, doPlay, doSleep, doClean, nudge,
          exportJSON, importJSON, resetAll
        };
      }
    }).mount('#app');
  })();
  </script>
</body>
</html>
